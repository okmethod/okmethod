# mechanics: どのように品質特性のバランスをとるか (WIP)

**コンセプト**: トレードオフの力学を理解し、システムに求められる品質特性(-ility)を実現する

---

## 関連キーワード

- **CAP Theorem** (CAP 定理 - 分散システムの限界)
- **Eventual Consistency** (結果整合性 - いずれ整合する)
- **Idempotency** (冪等性 - 何度実行しても結果は同じ)
- **Circuit Breaker** (サーキットブレーカー - 障害遮断)
- **Observability** (オブザーバビリティ - 可観測性)
- **Distributed Tracing** (分散トレーシング - リクエストの追跡)
- **Health Check** (ヘルスチェック - 生存確認)
- **Graceful Shutdown** (グレースフルシャットダウン - 安全な停止)

---

## 整合性と信頼性の心得

**_分散システムにおける「完全な整合性」を諦め、現実的な解を選ぶ。_**

### 分散トランザクションを避ける

- マイクロサービスや複数の DB を跨ぐトランザクション（2PC, XA）は、複雑でパフォーマンスが悪いため、極力避ける
- 原則として、1 つのトランザクションは 1 つのサービスの 1 つの DB 内で完結させる
  - どうしても整合性が必要な場合は、「結果整合性（Eventual Consistency）」を採用し、メッセージキューや Saga パターンを用いて非同期に整合させる

### 冪等性（Idempotency）を徹底する

- ネットワークは信頼できないため、リクエストのリトライは必ず発生する
- すべての更新系 API（POST/PUT）やメッセージ処理は、同じリクエストが 2 回来ても問題ないように実装する
  - 例: 注文 ID をキーにして、既に処理済みならスキップする

### 障害を局所化する（Circuit Breaker）

- 依存している外部システムや別サービスがダウンした際、自システムまで道連れにダウンしないようにする
- 呼び出し失敗が一定回数続いたら、即座にエラーを返す（回路を開く）仕組みを導入し、スレッドプール枯渇等の二次災害を防ぐ

---

## 可観測性の心得

**_「何が起きているか」ではなく「なぜ起きているか」を知るための仕組みを入れる。_**

### ログだけでは不十分と知る

- ログ（個別イベント）、メトリクス（集計値）、トレース（リクエストの連鎖）の 3 本柱を整備する
- 特に分散システム（マイクロサービス）では、1 つのリクエストが複数のサービスを通過するため、「分散トレーシング（Trace ID の伝播）」が必須となる
  - これがないと、どのサービスがボトルネックになっているか特定できない

### 相関 ID（Correlation ID）を付与する

- すべてのログに「リクエスト ID」や「ユーザー ID」を付与し、一連の処理の流れを串刺しで検索できるようにする
  - 構造化ログ（JSON 形式）を採用し、検索・集計しやすくする

---

## セキュリティと回復性の心得

**_「安全である」と過信せず、「侵害される前提」で設計する。_**

### ゼロトラストを前提にする

- 「社内ネットワーク（VPC 内）だから安全」という境界型防御の考えを捨てる
- サービス間の通信であっても、相互認証（mTLS 等）や都度の認可チェックを行い、最小権限の原則を徹底する

### 失敗できるようにする（Graceful Degradation）

- 一部の機能が壊れても、システム全体のメイン機能だけは動かし続ける
  - 例: 「おすすめ商品」サービスの応答がなくても、トップページや商品購入機能は表示させる（フォールバック処理）
- システム停止時やデプロイ時は、処理中のリクエストを完了させてから停止する「グレースフルシャットダウン」を実装する
